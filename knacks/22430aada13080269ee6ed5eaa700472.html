<h1>üèÅ <b>Objetivos</b></h1>

<p>Los <b>rootkits</b> son programas maliciosos que permiten a un atacante mantener el acceso no autorizado a un sistema inform√°tico, ocultando su presencia y sus actividades. Detectarlos es crucial para la seguridad del servidor, ya que comprometen la integridad y confidencialidad de la informaci√≥n. Este <i>Knack</i> tiene como objetivo guiar en la instalaci√≥n y el uso de <i>chkrootkit</i> y <i>rkhunter</i>, dos herramientas populares en sistemas <i>Ubuntu</i> para escanear el sistema en busca de signos de amenazas y vulnerabilidades como <b>rootkits</b> conocidos, backdoors y exploits. Integrar estas herramientas en la rutina de seguridad del servidor ayuda a identificar y mitigar posibles compromisos, proporcionando una capa adicional de defensa contra amenazas avanzadas.</p>

<h1>üë®üèΩ‚Äçüè´ <b>Instrucciones</b></h1>

<h2>Actualizar el sistema operativo</h2>

<h2>Actualizar el servidor</h2>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Conectarse de manera remota al servidor mediante un terminal. Ver: <a target='_blank' rel='noopener noreferrer' href='https://www.notion.so/Windows-Conectarse-a-instancias-Linux-con-PuTTY-21a30aada1308040a698e53a70e62c41?pvs=21'>Windows: <b>Conectarse a instancias Linux con PuTTY</b></a>.</span></li>

</ul>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Actualizar el √≠ndice de paquetes disponibles desde los repositorios de <i>Ubuntu</i> e instalar las actualizaciones pendientes. La opci√≥n <code>-y</code> acepta autom√°ticamente todas las preguntas de confirmaci√≥n, lo que es √∫til para actualizaciones no interactivas.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>sudo apt update && sudo apt upgrade -y
</code></pre></div>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Si el sistema necesita un reinicio, introducir el siguiente comando y esperar un minuto o dos hasta que el servidor se reinicie por completo y pueda conectarse de nuevo.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>sudo reboot
</code></pre></div>

<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/1GbWwtpF/image.png' alt='image'>
<h2>Instalar y ejecutar chkrootkit</h2>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Instalar el paquete <i>chkrootkit</i>.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>sudo apt install -y chkrootkit
</code></pre></div>

<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/TDVMWRT4/image-1.png' alt='image 1'>
<div class='div-featured'>
<span class='img-featured'>‚ÑπÔ∏è</span>
<span class='txt-featured'>Durante el proceso de instalaci√≥n, se instala <i>Postfix</i> como dependencia que pedir√° elegir una opci√≥n para configurar el env√≠o de mensajes de correo. Si ya dispone de un <b>Mail Transfer Agent</b> (<b>MTA</b>) configurado, elegir la opci√≥n que desee usar para el env√≠o de mensajes. Si no tiene un <b>MTA</b>, seleccione la primera opci√≥n: <code>No configuration</code>, <code>Tab</code> para saltar al bot√≥n <code>Ok</code> y <code>Enter</code>.
</span></div>

<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/j9M8wV3L/image-2.png' alt='image 2'>
<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/4n4qFqK2/image-3.png' alt='image 3'>
<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Ejecutar <i>chkrootkit</i> para escanear el sistema en busca de <b>rootkits</b>. El escaneo puede tomar varios minutos.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>sudo chkrootkit
</code></pre></div>

<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/Z6ZCntGD/image-4.png' alt='image 4'>
<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/b5Pdm8Jd/image-5.png' alt='image 5'>
<div class='div-featured'>
<span class='img-featured'>‚úÖ</span>
<span class='txt-featured'>Una salida que muestre <code>not found</code> o <code>not infected</code> para la mayor√≠a de las verificaciones indica que no se encontraron anomal√≠as conocidas.
</span></div>

<div class='div-featured'>
<span class='img-featured'>‚ö†Ô∏è</span>
<span class='txt-featured'>Los mensajes <code>WARNING</code> se pueden descartar verificando que sean <b>falsos positivos</b>. Es com√∫n ver advertencias o mensajes no cr√≠ticos, especialmente para:
<ul>
  <li>Los relacionados con herramientas como <i>ifconfig</i>, <i>ssh</i> o <i>sshd</i> si son versiones confiables.</li>

</ul>

<ul>
  <li><b>Sockets de sniffer</b> de paquetes abiertos o <b>interfaces de red</b> en modo <b>promiscuo</b>. Un ejemplo es <i>systemd-networkd</i>, que es un <b>demonio del sistema</b> en <i>Linux</i> que gestiona y configura las interfaces de red. Se puede confirmar es un falso positivo de la siguiente forma:</li>

</ul>

<ol>
  <li>Verificar que el proceso pertenece al servicio se√±alado.</li>

</ol>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>ps -fp 85739
</code></pre></div>

<ol>
  <li>Debe coincidir con un comando propio del sistema, con proceso padre (<code>PPID</code>) bajo y terminal (<code>TTY</code>) asociada a procesos de sistema: <code>?</code>.</li>

</ol>

<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/TdzD29T/image-6.png' alt='image 6.png'>
<ul>
  <li><b>Dotfiles</b> (ficheros ocultos) de paquetes oficiales. Ejemplos pueden ser <i>Fail2Ban</i> o <i>Twisted</i> (un conocido <b>framework</b> de red). Se puede confirmar son un falso positivo compar√°ndolos con el paquete original, por ejemplo para <i>Twisted</i>:</li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>dpkg -S /usr/lib/python3/dist-packages/twisted/trial/newsfragments/.gitignore
</code></pre></div>

<ol>
  <li>Identificado el nombre (ej. <i>python3-twisted</i>), verificar con <i>debsums</i> la integridad del paquete.</li>

</ol>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>sudo debsums python3-twisted
</code></pre></div>

<ol>
  <li>El paquete est√° √≠ntegro si la salida solo muestra archivos no coincidentes (modificados) por cambios esperados (ej. archivos de configuraci√≥n editados tras su instalaci√≥n). Si alg√∫n <b>dotfile</b> (ej. <code>.gitignore</code>) u otros archivos son listados como modificados sin una raz√≥n leg√≠tima, entonces existe una posibilidad de infecci√≥n.</li>

</ol>

<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/q3dNYv3V/image-7.png' alt='image 7.png'>
</span></div>

<div class='div-featured'>
<span class='img-featured'>‚ò†Ô∏è</span>
<span class='txt-featured'>Cualquier salida inusual o <code>INFECTED</code> requiere investigaciones m√°s profundas.
</span></div>

<h2>Instalar y configurar <i>rkhunter</i></h2>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Instalar el paquete <i>rkhunter</i>.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>sudo apt install -y rkhunter
</code></pre></div>

<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/xK9qFkNM/image-8.png' alt='image 8'>
<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Abrir el fichero de configuraci√≥n de <i>rkhunter</i>.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>sudo nano /etc/rkhunter.conf
</code></pre></div>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Buscar la l√≠nea <code>ROTATE_MIRRORS=</code>, descomentarla si es necesario y establecer su valor a <code>1</code>.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>ROTATE_MIRRORS=1
</code></pre></div>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Buscar la l√≠nea <code>UPDATE_MIRRORS=</code>, descomentarla si es necesario  y establecer su valor a <code>1</code>.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>UPDATE_MIRRORS=1
</code></pre></div>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Buscar la l√≠nea <code>MIRRORS_MODE=</code>, descomentarla si es necesario  y establecer su valor a <code>0</code>.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>MIRRORS_MODE=0
</code></pre></div>

<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/279XgR7c/image-9.png' alt='image 9'>
<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Buscar la l√≠nea <code>WEB_CMD=</code>, descomentarla si es necesario y si su valor es <code>WEB_CMD="/bin/false"</code>, modificarlo por <code>WEB_CMD=wget</code> (<b>no incluir comillas</b>).</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>WEB_CMD=wget
</code></pre></div>

<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/p6drppfM/image-10.png' alt='image 10'>
<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Buscar la secci√≥n de l√≠neas <code>ALLOWHIDDENFILE=</code> y agregar los siguientes par√°metros para excluir alertas de <b>falsos positivos</b>.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'># Whitelist legitimate hidden files in /etc
ALLOWHIDDENFILE=/etc/.resolv.conf.systemd-resolved.bak
ALLOWHIDDENFILE=/etc/.updated
</code></pre></div>

<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/1tgFYy4Y/image-11.png' alt='image 11'>
<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Guardar los cambios presionando <code>Ctrl+X</code>, luego <code>Y</code> y <code>Enter</code>.</span></li>

</ul>

<h2>Actualizar <i>rkhunter</i></h2>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Actualizar la base de datos de <i>rkhunter</i> con las √∫ltimas definiciones de amenazas. Es fundamental ejecutar este comando despu√©s de la instalaci√≥n y <b>peri√≥dicamente antes</b> de cada escaneo.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>sudo rkhunter --update
</code></pre></div>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Ejecutar una verificaci√≥n de la integridad de los archivos. Esto crea una base de datos de los hashes de archivos del sistema, que <i>rkhunter</i> utilizar√° en escaneos futuros para detectar modificaciones.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>sudo rkhunter --propupd
</code></pre></div>

<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/665b9CB/image-12.png' alt='image 12'>
<div class='div-featured'>
<span class='img-featured'>‚ö†Ô∏è</span>
<span class='txt-featured'><b>IMPORTANTE:</b> Es crucial ejecutar <code>--propupd</code> <b>inmediatamente despu√©s</b> de la instalaci√≥n inicial y cada vez que se realicen actualizaciones significativas del sistema o de paquetes importantes, ya que de lo contrario <i>rkhunter</i> reportar√° cambios leg√≠timos como posibles advertencias (<b>falsos positivos</b>).
</span></div>

<h2>Ejecutar <i>rkhunter</i></h2>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Ejecutar <i>rkhunter</i> para escanear el sistema en busca de <b>rootkits</b>, puertas traseras y vulnerabilidades. Este escaneo puede tomar varios minutos, donde <i>rkhunter</i> har√° una pausa para que se pueda revisar la salida de cada fase del escaneo y pedir√° confirmaci√≥n despu√©s de cada secci√≥n.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>sudo rkhunter -c
</code></pre></div>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Presionar <code>Enter</code> para continuar el escaneo en cada pausa.</span></li>

</ul>

<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/BH9fcPCK/image-13.png' alt='image 13'>
<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Al finalizar el escaneo, <i>rkhunter</i> generar√° un resumen. Buscar el bloque <code>System checks summary</code> y, si no hay signos de infecci√≥n, deben reportarse cero hallazgos y aparecer los mensajes <code>No warnings were found while checking the system</code>, <code>No rootkits found</code> o <code>No security issues</code>.</span></li>

</ul>

<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/j9732psG/image-14.png' alt='image 14'>
<h2>Automatizar escaneos de <i>rkhunter</i> con <b>cron</b></h2>

<div class='div-featured'>
<span class='img-featured'>‚ÑπÔ∏è</span>
<span class='txt-featured'>Se recomienda habilitar el escaneo diario del servidor, activar la actualizaci√≥n semanal de las bases de datos y actualizar autom√°ticamente sus propiedades de archivos (<code>--propupd</code>) despu√©s de una actualizaci√≥n. Los resultados se registrar√°n en <code>/var/log/rkhunter/rkhunter.log</code>. Tambi√©n puede configurarse para enviar correos electr√≥nicos si se tiene un <b>MTA</b> configurado.
</span></div>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Abrir el fichero de configuraci√≥n de <code>cron</code> para <i>rkhunter</i>.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>sudo nano /etc/default/rkhunter
</code></pre></div>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Buscar las siguientes l√≠neas y establecer sus valores a <code>true</code>.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>CRON_DAILY_RUN="true"
CRON_DB_UPDATE="true"
APT_AUTOGEN="true"
</code></pre></div>

<img target='_blank' rel='noopener noreferrer' src='https://i.ibb.co/xK6j5RZ7/image-15.png' alt='image 15'>
<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Guardar los cambios presionando <code>Ctrl+X</code>, luego <code>Y</code> y <code>Enter</code>.</span></li>

</ul>

<h2>Revisar logs y reportes de <i>chkrootkit</i> y <i>rkhunter</i></h2>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Se pueden revisar los logs de <i>chkrootkit</i> para ver el historial de escaneos manuales diarios. Presionar <code>q</code> para salir del visor <code>less</code>.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>sudo less /var/log/chkrootkit/chkrootkit-daily.log
</code></pre></div>

<ul class='lst-task'>
  <li><label class='chk-task'></label><span>Se pueden revisar los logs de <i>rkhunter</i> para ver los resultados de los escaneos (manuales y autom√°ticos). Presionar <code>q</code> para salir del visor <code>less</code>.</span></li>

</ul>

<div class='div-code'><button class='btn-code'>Copiar</button><pre><code class='txt-code'>sudo less /var/log/rkhunter.log
</code></pre></div>

<h1>üìí Notas</h1>

<div class='div-featured'>
<span class='img-featured'>‚ö†Ô∏è</span>
<span class='txt-featured'>Es vital investigar cualquier advertencia o anomal√≠a reportada por <i>chkrootkit</i> o <i>rkhunter</i>. No todas las advertencias indican una infecci√≥n, pero muchas pueden se√±alar configuraciones incorrectas o riesgos potenciales.
</span></div>

<div class='div-featured'>
<span class='img-featured'>üîí</span>
<span class='txt-featured'>Para una seguridad a√∫n mayor, considere integrar estas herramientas con un sistema de monitoreo centralizado o un <b>SIEM (Security Information and Event Management)</b> para la gesti√≥n de logs y alertas.
</span></div>

<h1>‚û°Ô∏è Ver tambi√©n</h1>

<div class='div-featured'>
<span class='img-featured'>&#x2139&#xFE0F</span>
<span class='txt-featured'><a target='_blank' rel='noopener noreferrer' href='https://www.notion.so/22130aada13080e083cee097b4b16f8d?pvs=21'>VPS desde cero + EasyPanel + n8n + EvolutionAPI</a>
</span></div>

<h1>üéûÔ∏è Videos</h1>

<p><a target='_blank' rel='noopener noreferrer' href='https://www.youtube.com/watch?v=nZQ0DguvRWI'>https://www.youtube.com/watch?v=nZQ0DguvRWI</a></p>

<p><a target='_blank' rel='noopener noreferrer' href='https://www.youtube.com/watch?v=uggOVk3SDdo'>https://www.youtube.com/watch?v=uggOVk3SDdo</a></p>

<h1>üîó Enlaces relacionados</h1>

<p><a target='_blank' rel='noopener noreferrer' href='https://www.linuxtotal.com.mx/index.php?cont=info_seyre_011'>Checadores de rootkits en Linux - rkhunter y chkrootkit</a></p>

<p><a target='_blank' rel='noopener noreferrer' href='https://terranode.net/blog/detecta-rootkits-con-rkhunter-y-chkrootkit'>Detecta rootkits con RKHunter y Chkrootkit f√°cilmente - Terranode</a></p>

